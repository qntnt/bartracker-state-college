<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Heatmaps</title>
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
    <style>
      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
      }
      #map {
        height: 100%;
      }
      #floating-panel {
        position: absolute;
        top: 10px;
        right: 10px;
        z-index: 5;
        background-color: #fff;
        padding: 5px;
        border: 1px solid #999;
        text-align: center;
        font-family: 'Roboto','sans-serif';
        line-height: 30px;
        padding-left: 10px;
      }
      #floating-panel {
        background-color: #fff;
        border: 1px solid #999;
        right: 10px;
        padding: 5px;
        position: absolute;
        top: 10px;
        z-index: 5;
      }
    </style>
  </head>

  <body>
    <div id="floating-panel">
      <form id="barform">
          <select onchange="select()" id="barSelection">
            <option value="shandygaff">Shandygaff</option>
            <option value="den">The Den</option>
            <option value="rathskeller">Rathskeller</option>
            <option value="phyrst">The Phyrst</option>
            <option value="indigo">Indigo</option>
            <option value="cafe">Cafe</option>
            <option value="liberty">Liberty</option>
            <option value="inferno">Inferno</option>
            <option value="saloon">The Saloon</option>
            <option value="chrome">Chrome</option>
            <option value="primantis">Primanti Bros</option>
            <option value="darkhorse">The Darkhorse Tavern</option>
          </select>
          <button type="submit" class="btn btn-default">Submit</button>
      </form>
      <table class="table table-striped">
          <thead>
              <tr><th>Bar</th><th>Population</th></tr>
          </thead>
          <tbody id="popInfo">
          </tbody>
      </table>
    </div>
    <div id="map"></div>
    <script>

      // This example requires the Visualization library. Include the libraries=visualization
      // parameter when you first load the API. For example:
      // <script src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY&libraries=visualization">

      var map, heatmap, selectedBar, points, bars;

      function randPop(min, max) {
          return Math.floor(Math.random() * (max-min) + min);
      }

      function initMap() {
        var form = document.getElementById('barform');
        form.addEventListener('submit', submitBar);

        popmax = 30;
        popmin = 1;

        bars = {
            shandygaff: {
                name: 'Shandygaff',
                coords: new google.maps.LatLng(40.7952877, -77.8597121),
                pop: randPop(1, 30)
            },
            den: {
                name: 'The Den',
                coords: new google.maps.LatLng(40.7975414, -77.8568027),
                pop: randPop(1, 30)
            },
            rathskeller: {
                name: 'Rathskeller',
                coords: new google.maps.LatLng(40.7950093, -77.8604945),
                pop: randPop(1, 30)
            },
            phyrst: {
                name: 'The Phyrst',
                coords: new google.maps.LatLng(40.7937613, -77.8602774),
                pop: randPop(1, 30)
            },
            indigo: {
                name: 'Indigo',
                coords: new google.maps.LatLng(40.7939879, -77.8618917),
                pop: randPop(1, 30)
            },
            cafe: {
                name: 'Cafe',
                coords: new google.maps.LatLng(40.7931322,-77.8629912),
                pop: randPop(1, 30)
            },
            liberty: {
                name: 'Liberty',
                coords: new google.maps.LatLng(40.7974817,-77.8573924),
                pop: randPop(1, 30)
            },
            inferno: {
                name: 'Inferno',
                coords: new google.maps.LatLng(40.7973497,-77.8574923),
                pop: randPop(1, 30)
            },
            saloon: {
                name: 'The Saloon',
                coords: new google.maps.LatLng(40.7972969,-77.8574433),
                pop: randPop(1, 30)
            },
            chrome: {
                name: 'Chrome',
                coords: new google.maps.LatLng(40.7918011,-77.8620385),
                pop: randPop(1, 30)
            },
            primantis: {
                name: 'Primanti Bros',
                coords: new google.maps.LatLng(40.7967017,-77.8570625),
                pop: randPop(1, 30)
            },
            darkhorse: {
                name: 'The Darkhorse Tavern',
                coords: new google.maps.LatLng(40.7947671,-77.860574),
                pop: randPop(1, 30)
            },
        }

        selectedBar = "shandygaff";

        dataPoints = Object.keys(bars).map(function (bar) {
            return {
                location: bars[bar].coords,
                weight: bars[bar].pop
            };
        });

        map = new google.maps.Map(document.getElementById('map'), {
          zoom: 16,
          center: {lat: 40.7948, lng: -77.8563},
          mapTypeId: google.maps.MapTypeId.MAP
        });

        heatmap = new google.maps.visualization.HeatmapLayer({
          data: getPoints(),
          radius: 30,
          map: map
        });

        changeGradient();

        addMarkers();
        dataPoints = dataPoints.concat(randPoints());
        refreshMap();
      }


        function getPopInfo() {
            rows = Object.keys(bars).map(function (bar) {
                return '<tr><td>'+bars[bar].name + "</td><td>" + bars[bar].pop + "</td></tr>";
            }).join('');

            return rows ;
        }

        function addMarkers() {
            Object.keys(bars).forEach(function (name) {
                addMarker(name);
            })
        }
        function addMarker(name) {
            var mark = new google.maps.Marker({
              position: bars[name].coords,
              map: map,
              title: bars[name].name,
              label: name[0].toUpperCase()
            });
            var info = new google.maps.InfoWindow({
              content: bars[name].name
            });
            mark.addListener('click', function() {
              bars[name].pop++;
              dataPoints.push(bars[name].coords);

              info.set('content', bars[name].name + ": " + bars[name].pop)
              info.open(map, mark);

              refreshMap();
            });
        }

      function toggleHeatmap() {
        heatmap.setMap(heatmap.getMap() ? null : map);
      }

      function changeGradient() {
        var gradient = [
          'rgba(0, 0, 0, 0)',
          'rgba(0, 0, 255, 0.5)',
          'rgba(0, 255, 0, 0.75)',
          'rgba(255, 255, 0, 0.85)',
          'rgba(255, 0, 0, 0.95)',
        ]
        heatmap.set('gradient', heatmap.get('gradient') ? null : gradient);
      }

      function submitBar(e) {
          e.preventDefault();

          bars[selectedBar].pop++;
          dataPoints.push(bars[selectedBar].coords);

          refreshMap();
      }

      function select(bar) {
          var selectBox= document.getElementById('barSelection');
          var selectedValue = selectBox.options[selectBox.selectedIndex].value;
          selectedBar = selectedValue;
          console.log('Selected: ' + selectedBar);
      }

      function changeRadius() {
        heatmap.set('radius', heatmap.get('radius') ? null : 20);
      }

      function changeOpacity() {
        heatmap.set('opacity', heatmap.get('opacity') ? null : 0.2);
      }

      function refreshMap() {
        heatmap.setData(getPoints())
        document.getElementById('popInfo').innerHTML = getPopInfo();
      }

      function randPoints() {
        var barslist = Object.keys(bars);
        var totalPop = bars[barslist[0]].pop;
        var avglat = bars[barslist[0]].coords.lat() * totalPop;
        var avglng = bars[barslist[0]].coords.lng() * totalPop;

        for (var i=1; i<barslist.length; i++) {
            var pop = bars[barslist[i]].pop;
            avglat += bars[barslist[i]].coords.lat() * pop;
            avglng += bars[barslist[i]].coords.lng() * pop;
            totalPop += pop;
        }
        if (totalPop > 0) {
            avglat = avglat / totalPop;
            avglng = avglng / totalPop;
        }

        var randPoints = []
        var samples = 10
        var extraPopulation = 400
        for (var i=0; i<=extraPopulation; i++) {
            var lat = Math.random();
            var lng = Math.random();
            for (var j=0; j<samples; j++) {
                lat += Math.random();
                lng += Math.random();
            }
            lat -= samples/2;
            lng -= samples/2;
            lat = lat / (samples/2);
            lng = lng / (samples/2);
            randPoints.push(new google.maps.LatLng(avglat+lat/200, avglng+lng/200));
        }
        return randPoints;
      }

      // Heatmap data: 500 Points
      function getPoints() {
        return dataPoints;
      }
    </script>
    <script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBx2gQVaYAbMKtMMJgWaCyV7Y6-XXexg0Q&libraries=visualization&callback=initMap">
    </script>
  </body>
</html>
